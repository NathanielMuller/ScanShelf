<ion-header>
  <ion-toolbar>
    <ion-title>
      <ion-icon name="add-outline" slot="start"></ion-icon>
      Nuevo Producto
    </ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="dismiss()">
        <ion-icon name="close-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="modal-content">
  <form [formGroup]="productForm" (ngSubmit)="saveProduct()">
    
    <!-- Información del Producto -->
    <div class="form-section">
      <h3 class="section-title">
        <ion-icon name="information-circle-outline"></ion-icon>
        Información del Producto
      </h3>

      <ion-item class="form-item">
        <ion-label position="stacked">Nombre del Producto *</ion-label>
        <ion-input 
          formControlName="name"
          placeholder="Ej: iPhone 15 Pro"
          type="text">
        </ion-input>
      </ion-item>
      <div *ngIf="productForm.get('name')?.invalid && productForm.get('name')?.touched" class="error-message">
        <small>El nombre del producto es requerido</small>
      </div>

      <ion-item class="form-item">
        <ion-label position="stacked">Categoría *</ion-label>
        <ion-select formControlName="category" placeholder="Selecciona una categoría">
          <ion-select-option *ngFor="let category of categories" [value]="category">
            {{ category }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item class="form-item">
        <ion-label position="stacked">Marca</ion-label>
        <ion-input 
          formControlName="brand"
          placeholder="Ej: Apple, Samsung, Nike..."
          type="text">
        </ion-input>
      </ion-item>

      <ion-item class="form-item">
        <ion-label position="stacked">Código de Barras</ion-label>
        <ion-input 
          formControlName="barcode"
          placeholder="Escanea o ingresa manualmente"
          type="text">
        </ion-input>
        <ion-button slot="end" fill="clear" (click)="scanBarcode()">
          <ion-icon name="barcode-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-item>
    </div>

    <!-- Stock y Precio -->
    <div class="form-section">
      <h3 class="section-title">
        <ion-icon name="cube-outline"></ion-icon>
        Stock y Precio
      </h3>

      <div class="form-row">
        <ion-item class="form-item">
          <ion-label position="stacked">Stock Actual *</ion-label>
          <ion-input 
            formControlName="stock"
            placeholder="0"
            type="number"
            min="0">
          </ion-input>
        </ion-item>

        <ion-item class="form-item">
          <ion-label position="stacked">Stock Mínimo *</ion-label>
          <ion-input 
            formControlName="minStock"
            placeholder="1"
            type="number"
            min="0">
          </ion-input>
        </ion-item>
      </div>

      <ion-item class="form-item">
        <ion-label position="stacked">Precio *</ion-label>
        <ion-input 
          formControlName="price"
          placeholder="0.00"
          type="number"
          min="0"
          step="0.01">
        </ion-input>
      </ion-item>
    </div>

    <!-- Imagen del Producto -->
    <div class="form-section">
      <h3 class="section-title">
        <ion-icon name="camera-outline"></ion-icon>
        Imagen del Producto
      </h3>

      <div class="image-container">
        <div *ngIf="!productImage" class="image-placeholder" (click)="selectImageSource()">
          <ion-icon name="camera-outline"></ion-icon>
          <p>Toca para agregar una imagen</p>
        </div>
        
        <div *ngIf="productImage" class="image-preview">
          <img [src]="productImage" alt="Imagen del producto">
          <ion-button fill="clear" class="remove-image-btn" (click)="removeImage()">
            <ion-icon name="close-circle" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
      </div>
    </div>

    <!-- Descripción -->
    <div class="form-section">
      <h3 class="section-title">
        <ion-icon name="document-text-outline"></ion-icon>
        Descripción
      </h3>

      <ion-item class="form-item">
        <ion-label position="stacked">Descripción (Opcional)</ion-label>
        <ion-textarea 
          formControlName="description"
          placeholder="Descripción detallada del producto..."
          rows="3">
        </ion-textarea>
      </ion-item>
    </div>

    <!-- Mensaje de estado simple -->
    <div class="status-message" *ngIf="statusMessage">
      <ion-chip [color]="statusMessage.type" class="status-chip">
        <ion-icon [name]="statusMessage.type === 'success' ? 'checkmark-outline' : 'information-outline'"></ion-icon>
        <ion-label>{{ statusMessage.text }}</ion-label>
      </ion-chip>
    </div>

    <!-- Botones -->
    <div class="form-buttons">
      <ion-button fill="clear" (click)="dismiss()" class="cancel-btn">
        <ion-icon name="close-outline" slot="start"></ion-icon>
        Cancelar
      </ion-button>
      <ion-button 
        fill="solid" 
        [disabled]="productForm.invalid || isLoading"
        (click)="saveProduct()"
        class="save-btn">
        <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
        <ion-icon *ngIf="!isLoading" name="checkmark-outline" slot="start"></ion-icon>
        {{ isLoading ? 'Guardando...' : 'Guardar' }}
      </ion-button>
    </div>

  </form>
</ion-content>

<!-- Scanner UI Overlay -->
<div class="scanner-ui" *ngIf="isScanning">
  <h2 class="scanner-title">Escanear Código de Barras</h2>
  <div class="scanner-frame"></div>
  <p class="scanner-instructions">Coloca el código dentro del marco</p>
  <ion-button fill="outline" color="light" (click)="stopScan()" class="scanner-cancel-btn">
    <ion-icon name="close-outline" slot="start"></ion-icon>
    Cancelar
  </ion-button>
</div>